<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>短距離ゴールタイマー</title>
<style>
body { font-family: sans-serif; text-align: center; margin: 0; padding: 0; background: #f5f5f5; }
#videoContainer { position: relative; display: inline-block; margin-top: 20px; }
video, canvas { border-radius: 10px; }
canvas { position: absolute; top: 0; left: 0; }
button { padding: 10px 16px; margin: 8px; font-size: 16px; border-radius: 6px; border: none; background-color: #00B48C; color: white; cursor: pointer; }
button:disabled { background-color: #999; cursor: not-allowed; }
#timer { font-size: 24px; margin-top: 10px; }
</style>
</head>
<body>

<h2>短距離ゴールタイマー</h2>

<div id="videoContainer">
  <video id="video" autoplay playsinline width="360" height="270"></video>
  <canvas id="canvas" width="360" height="270"></canvas>
</div>

<div id="timer">タイマー: 0.000 s</div>

<div>
  <button id="initBtn">ワンタッチでカメラ起動</button>
  <button id="startBtn" disabled>スタート</button>
  <button id="stopBtn" disabled>ストップ</button>
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const timerDiv = document.getElementById('timer');
const initBtn = document.getElementById('initBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');

let timerRunning = false;
let startTime = 0;
let lastFrame = null;
const finishLineX = canvas.width * 0.85;
const threshold = 20;
let cameraStarted = false;

// ワンタッチでカメラ起動
initBtn.addEventListener('click', async () => {
  if (cameraStarted) return;
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
    video.srcObject = stream;
    cameraStarted = true;
    initBtn.disabled = true;
    startBtn.disabled = false;
    detectMotion();
    updateTimer();
  } catch(err) {
    alert('カメラを起動できません: ' + err);
  }
});

// タイマー
function updateTimer() {
  if (timerRunning) {
    const elapsed = (performance.now() - startTime) / 1000;
    timerDiv.textContent = `タイマー: ${elapsed.toFixed(3)} s`;
  }
  requestAnimationFrame(updateTimer);
}
function startTimer() {
  timerRunning = true;
  startTime = performance.now();
  startBtn.disabled = true;
  stopBtn.disabled = false;
}
function stopTimer() {
  timerRunning = false;
  startBtn.disabled = false;
  stopBtn.disabled = true;
}

// 簡易動体検知＋ゴール判定
function detectMotion() {
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);

  if (lastFrame) {
    let diff = 0;
    for (let i=0; i<frame.data.length; i+=4) {
      diff += Math.abs(frame.data[i]-lastFrame.data[i])
            + Math.abs(frame.data[i+1]-lastFrame.data[i+1])
            + Math.abs(frame.data[i+2]-lastFrame.data[i+2]);
    }
    const avgDiff = diff / (frame.data.length/4);
    if (timerRunning && avgDiff > threshold) {
      let maxX = 0;
      for (let y=0; y<canvas.height; y+=4) {
        for (let x=0; x<canvas.width; x+=4) {
          const idx = (y*canvas.width + x)*4;
          const brightness = (frame.data[idx]+frame.data[idx+1]+frame.data[idx+2])/3;
          if (brightness>30 && x>maxX) maxX=x;
        }
      }
      if (maxX >= finishLineX) stopTimer();
    }
  }

  lastFrame = frame;

  // ゴールライン表示
  ctx.strokeStyle='red';
  ctx.lineWidth=3;
  ctx.setLineDash([6]);
  ctx.beginPath();
  ctx.moveTo(finishLineX,0);
  ctx.lineTo(finishLineX,canvas.height);
  ctx.stroke();

  requestAnimationFrame(detectMotion);
}

// イベント
startBtn.addEventListener('click', startTimer);
stopBtn.addEventListener('click', stopTimer);
</script>

</body>
</html>
